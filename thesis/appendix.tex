%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Anhang
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix

%\setcounter{secnumdepth}{-1}
%\chapter{Appendix}
\chapter{Supplementary Tables}\label{chap:tables}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\center
\begin{tabular}{c|c}
\toprule
Time    & Action [kWh/kWH\_capacity]     \\
\midrule
1 AM -- 6 AM & +0.05532 \\
7 AM -- 3 PM & -0.02         \\
4 PM -- 6 PM & -0.0044 \\
7 PM -- 10 PM & -0.024 \\
11 PM -- 0 AM & +0.034  \\
\bottomrule    
\end{tabular}
\caption{Rules of the RBC implemented in CityLearn.}
\label{app:rbc-rules}
\end{table}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\begin{tabularx}{\linewidth}{lXc}
\toprule
Attribute name & Description & Value \\
\midrule
Capacity & Maximum amount of energy the storage device can store & 6.4 kWh \\
Efficiency & Technical efficiency & 90 \% \\
Capacity loss coefficient & Storage capacity lost in each charge and discharge cycle (as a fraction of the total capacity) & $1e^{-5}$ \\
Loss coefficient & Standby hourly losses & 0 \\
Nominal power & Maximum amount of electric power that the battery can use to charge or discharge & 5 kW \\
\bottomrule
\end{tabularx}
\caption[Attributes of the batteries of each building]{Attributes of the batteries of each building. Description of the attributes obtained from \url{https://www.citylearn.net/api/citylearn.energy_model.html}.}
\label{app:battery-attributes}
\end{table}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\center
\begin{tabular}{c|c}
\toprule
Building & Energy Consumption Median $\bar{E}_b$
%& Energy Consumption without storage Median & Energy Consumption without storage and PV Median 
\\
\midrule
1  & 0.54 %& 0.58 & 0.81 
\\
2  & 0.45 %& 0.49 & 0.74 
\\
3  & 0.25 %& 0.28 & 0.56 
\\
4 & 0.52 %& 0.54 & 0.94  
\\
5 & 0.29 %& 0.29 & 0.74 
\\
6 & 0.5 % & 0.56 & 1.08 
\\
7 & 0.21 %& 0.21 & 0.33 
\\
8 & 0.31 %& 0.32 & 0.68 
\\
9  & 0.36 %& 0.38 & 0.46 
\\
10 & 0.56 %& 0.65 & 0.98
\\
11 & 0.66 %& 0.71 & 1.19 
\\
12 & 0.0 %& 0.0 & 0.0 
\\
13 & 0.43 %& 0.48 & 0.97 
\\
14 & 0.49 %& 0.48 & 0.59 
\\
15 & 0.12 %& 0.0 & 0.0 
\\
16 & 0.55 %& 0.72 & 1.2 
\\
17 & 0.75 \\% & 0.82 & 1.24 \\
\bottomrule
\end{tabular}
\caption[Median values for energy consumption per hour $\bar{E}_b$]{Median values for energy consumption per hour $\bar{E}_b$ obtained by training the SAC agent with the default hyperparameters.}
\label{tab:building-medians}
\end{table}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\begin{tabularx}{\linewidth}{l|X}
\toprule
Name & Description \\
\midrule
month & 1 (January) through 12 (December)\\
day\_type & type of day as provided by EnergyPlus (from 1 to 8). 1 (Sunday), 2 (Monday), ..., 7 (Saturday), 8 (Holiday)\\
hour & hour of day (from 1 to 24)\\
 t\_out & outdoor temperature in Celcius degrees.\\
 t\_out\_pred\_6h & outdoor temperature predicted 6h ahead \\
 t\_out\_pred\_12h & outdoor temperature predicted 12h ahead \\
 t\_out\_pred\_24h & outdoor temperature predicted 24h ahead \\
 rh\_out & outdoor relative humidity in \%.\\
 rh\_out\_pred\_6h & outdoor relative humidity predicted 6h ahead \\
 rh\_out\_pred\_12h & outdoor relative humidity predicted 12h ahead \\
 rh\_out\_pred\_24h & outdoor relative humidity predicted 24h ahead \\
 diffuse\_solar\_rad & diffuse solar radiation in $W/m^2$.\\
 diffuse\_solar\_rad\_pred\_6h & diffuse solar radiation predicted 6h ahead \\
 diffuse\_solar\_rad\_pred\_12h & diffuse solar radiation predicted 12h ahead \\
 diffuse\_solar\_rad\_pred\_24h & diffuse solar radiation predicted 24h ahead \\
 direct\_solar\_rad & direct solar radiation in $W/m^2$. \\
 direct\_solar\_rad\_pred\_6h & direct solar radiation predicted 6h ahead \\ 
 direct\_solar\_rad\_pred\_12h & direct solar radiation predicted 12h ahead \\ 
 direct\_solar\_rad\_pred\_24h & direct solar radiation predicted 24h ahead \\ 
 wind\_speed & wind speed in $m/s$ \\
 wind\_speed\_pred\_6h & wind speed predicted 6h ahead \\
 wind\_speed\_pred\_12h & wind speed predicted 12h ahead \\
 wind\_speed\_pred\_24h & wind speed predicted 24h ahead \\
 non\_shiftable\_load & electricity currently consumed by electrical appliances in kWh.\\ 
 solar\_gen & electricity currently being generated by photovoltaic panels in kWh.\\ 
 electrical\_storage\_soc & SOC of the electrical storage from 0 (no energy stored) to 1 (at full capacity). \\
 net\_electricity\_consumption & net electricity consumption of the building (including all energy systems) in the current time step. \\
 electricity\_pricing & electricity rate in $\$/kWh$ \\
 electricity\_pricing\_pred\_6h & electricity rate predicted 6 hours ahead. \\
 electricity\_pricing\_pred\_12h & electricity rate predicted 12 hours ahead. \\
 electricity\_pricing\_pred\_24h & electricity rate predicted 24 hours ahead. \\
 renewable\_energy\_share & share of renewable energy in the fuel mix of the grid. \\
\bottomrule
\end{tabularx}
\caption{Available state variables of the baseline SAC agent.}
\label{app:observation-space-sac}
\end{table}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\center
\begin{tabular}{c | c | c | c}
\toprule
Demonstrator                   & Mode & $\alpha_i$ & Deterministic demonstrator actions \\
\midrule
2 random                       & 1-6  & 0.2                      & Yes                          \\ 
\rule{0pt}{3ex}% EXTRA vertical height  
\multirow[t]{2}{*}{2 random}      & 1-3  & 0.01, 0.2, 1, 1.5        & No                           \\
                               & 4-6  & 0.01, 0.2                & No                           \\
\rule{0pt}{3ex}% EXTRA vertical height  
\multirow[t]{2}{*}{4 random}      & 1-3  & 0.01, 0.2, 1, 1.5        & No                           \\
                               & 4-6  & 0.01, 0.2                & No                           \\
\rule{0pt}{3ex}% EXTRA vertical height  
\multirow[t]{2}{*}{Pretrained B5} & 1-3, 5  & 0.01, 0.2, 1, 1.5        & No                           \\
                               & 4, 6  & 0.01, 0.2, 1             & No                           \\
\rule{0pt}{3ex}% EXTRA vertical height  
\multirow[t]{2}{*}{Pretrained B6} & 1-3  & 0.01, 0.2, 1, 1.5        & No                           \\
                               & 4-6  & 0.01, 0.2, 1             & No                          \\
\bottomrule
\end{tabular}
  \caption[Overview of the experiments for SAC-DemoPol.]{Overview of the experiments for our SAC-DemoPol. We tested different demonstrator, mode, and ILRs $\alpha_i$ combinations. Also, we examined the influence of using deterministic demonstrator actions instead of sampling them.}
  \label{app:social1-params}
\end{table}
}

\todo[inline]{Aktuell?}
{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\center
\begin{tabularx}{\textwidth}{c | Y | Y }
\toprule
Demonstrator                   & $\alpha_i$                                     & Deterministic policy actions  \\
\midrule
\rule{0pt}{3ex}% EXTRA vertical height  
\multirow[t]{3}{*}{2 random}      & $1e^{-4}$, $1e^{-3}$, 0.01, 0.03, 0.05, 0.1, 0.15, 0.2                & No\\
\rule{0pt}{2ex}% EXTRA vertical height  
                               & 0.03, 0.05, 0.1, 0.15, 0.2, 0.25                               & No                                          \\
\rule{0pt}{2ex}% EXTRA vertical height  
                               & 0.1, 0.15, 0.2, 0.25                                           & Yes                                           \\
\rule{0pt}{3ex}% EXTRA vertical height  
4 random                       & $1e^{-4}$, $1e^{-3}$, 0.01, 0.03, 0.05, 0.1, 0.15                     & No                  \\
\rule{0pt}{3ex}% EXTRA vertical height  
Pretrained B5                  & $1e^{-4}$, $1e^{-3}$, 0.01, 0.03, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8 & No                       \\
\rule{0pt}{3ex}% EXTRA vertical height  
\multirow[t]{2}{*}{Pretrained B6} & $1e^{-4}$, $1e^{-3}$, 0.01, 0.03, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8 & No                  \\
\rule{0pt}{2ex}% EXTRA vertical height  
                               & 0.1, 0.15, 0.2, 0.4, 0.6, 0.8                                  & Yes                  \\
                          \bottomrule                        
\end{tabularx}
  \caption[Overview of the experiments for SAC-DemoQ.]{Overview of the experiments for our SAC-DemoQ. We tested different demonstrator and ILRs $\alpha_i$ combinations. Also, we examined the influence of using deterministic demonstrator actions instead of sampling them.}
  \label{app:social2-params}
\end{table}
}

\clearpage
\chapter{Supplementary Figures}\label{sec:app-figures}
{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
    \center
     \includegraphics[width=\textwidth]{figures/building_daily_means.pdf}
  \caption{Daily means of the non-shiftable load and the solar generation of the buildings in kWh.}
  \label{app:building-daily-mean}
\end{figure}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
    \center
     \includegraphics[width=\textwidth]{figures/weather_daily_means.pdf}
  \caption{Daily means of the meteorologic observations and fuel mix in the grid.}
  \label{app:weather-daily-mean}
\end{figure}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
    \center
     \includegraphics[width=0.8\textwidth]{figures/electricity_pricing.pdf}
  \caption{Basic electricity price and fossil share-weighted price with a factor of $\beta=20$ for the initial week in the dataset.}
  \label{app:electricity-pricing}
\end{figure}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
    \center
     \includegraphics[width=\textwidth]{figures/prb_ddpg_kpis.pdf}
  \caption{}
  \label{app:prb-ddpg-kpis}
\end{figure}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
\center
     \includegraphics[width=\textwidth]{figures/social2_results_sharedobs.pdf}
  \caption[Results of the SAC-DemoQ with shared observations.]{Results of the fossil energy consumption KPI of the SAC-DemoQ with shared observation. The shaded areas show the standard deviation between the experiments with and without additional policy update, and the graphs show the mean value of them. One experiment with sampled and one with deterministic (determ.) demonstrator actions was conducted for both demonstrators.}
  \label{app:social2-results-sharedobs}
\end{figure}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
\center
     \includegraphics[width=\textwidth]{figures/shifted_sac_kpis.pdf}
  \caption[Results of the SAC Agents for the shifted data of B3 and B5.]{Results of the SAC Agents for the shifted data of B3 and B5 compared to the SAC baseline results of the training buildings.}
  \label{app:sac-shifted-kpis}
\end{figure}
}

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{figure}[htb]
\center
     \includegraphics[width=\textwidth]{figures/social_kpis.pdf}
  \caption[Results of the best-performing SAC and SAC-DemoQ Agents.]{Results of the best-performing SAC and SAC-DemoQ Agents for the training and the evaluation buildings.}
  \label{app:social-kpis}
\end{figure}
}

\clearpage
\chapter{Calculation of Key Performance Indicators}\label{sec:app-kpis}
To enhance readability, the time index~$t$ has been excluded from the presentation of required values and preliminary calculations.

\section{Fossil Energy Consumption}
\subsection*{Required Values}
\begin{tabularx}{\textwidth}{Xll}
\multicolumn{3}{l}{\hspace{-6px}\textit{Given in CityLearn Framework:}}                                                                                     \\
Electricity consumption of building $b$ from grid               & $e_b$            &  \\             
& & \\
\multicolumn{3}{l}{\hspace{-6px}\textit{Calculated:}}                                                                                                       \\
Scaled generated renewable energy in grid & $\hat{RE}_{gen}$ & (Equation \ref{eq:re-grid})
\end{tabularx}

\subsection*{Preliminary Calculations}
\textit{Total positive electricity consumption from grid:}
\begin{equation}
	\label{eq:energy-pos}
	E_{pos} = \sum_{b\in B} \max(e_b, 0)
\end{equation} 
Positive consumption is used to prevent sharing of surplus energy between buildings \vspace{10px} \\
\textit{Total consumed renewable energy from grid:}
\begin{equation}
	\label{eq:re-con-grid}
	RE_{con}^G = \min(E_{pos}, \hat{RE}_{gen}^G)
\end{equation} 

\subsection*{Formula}
\begin{equation}
\text{fossil energy consumption} = FE_{con} = \sum_t E_{pos}^t - RE_{con}^{G,t}
\end{equation}
over all time steps~$t$. \vspace{10px}

\begin{description}
\item[Interpretation] Total fossil energy consumption of all buildings.
\item[Level] District-level
\end{description}

\section{Average Fossil Share}
\subsection*{Required Values}
\begin{tabularx}{\textwidth}{Xll}
\multicolumn{3}{l}{\hspace{-6px}\textit{Given in CityLearn Framework:}}  \\
Electricity consumption of building $b$ from the grid               & $e_b$            &  \\             
Generated solar energy of building $b$ & $pv_{gen}^b$ & \\
& & \\
\multicolumn{3}{l}{\hspace{-6px}\textit{Calculated:}}                                                                                                       \\
Total positive electricity consumption from grid & $E_{pos}$ & (Equation \ref{eq:energy-pos}) \\
Total consumed renewable energy from grid & $RE_{con}^G$ & (Equation \ref{eq:re-con-grid})
\end{tabularx}

\subsection*{Preliminary Calculations}
\textit{Total solar energy consumption:}
\begin{equation}
	\label{eq:re-con-pv}
	RE_{con}^{PV} = \sum_{b\in B} \max(\min(e_{b} - pv_{gen}^b, - pv_{gen}^b), 0)
\end{equation}
Negative solar energy value is used since this is specified as a negative time series in the CityLearn framework. Solar energy only refers to the energy produced by the PVs of the buildings (excluding solar energy in the grid). \vspace{10px} \\
\textit{Total renewable energy consumption:}
\begin{equation}
	RE_{con} = RE_{con}^G + RE_{con}^{PV}
\end{equation}
\vspace{10px}\\
\textit{Proportion of total energy consumption attributed to renewable sources:}
\begin{equation}
	RE_{pct} = \frac{RE_{con}}{E_{pos} + RE_{con}^{PV}}
\end{equation}

\subsection*{Formula}
\begin{equation}
 \text{avg.~fossil~share} = 1- \frac{1}{24}\sum_{t=1}^{24}RE_{pct}^t.
\end{equation}
over all time steps~$t$. 

\begin{description}[leftmargin=3.15cm]
\item[Interpretation] The average daily fraction of fossil energy in the total energy consumption.
\item[Level] District-level
\end{description}

\section{Average Fossil Share Grid}
\subsection*{Required Values:}
\begin{tabularx}{\textwidth}{Xll}
\multicolumn{3}{l}{\hspace{-6px}\textit{Calculated:}}  \\
Total positive electricity consumption from grid & $E_{pos}$ & (Equation \ref{eq:energy-pos}) \\
Total consumed renewable energy from grid & $RE_{con}^G$ & (Equation \ref{eq:re-con-grid})
\end{tabularx}

\subsection*{Preliminary Calculations}
\textit{Proportion of grid energy consumption attributed to renewable sources:}
\begin{equation}
	RE_{pct}^G = \frac{RE_{con}^G}{E_{pos}}
\end{equation} 

\subsection*{Formula}
\begin{equation}
\text{avg.~fossil~share~grid} = 1-\frac{1}{24}\sum_{t=1}^{24}RE_{pct}^{G,t}.
\end{equation}
over all time steps~$t$. 
 
\begin{description}[leftmargin=3.15cm]
\item[Interpretation] The average daily fraction of fossil energy in the grid energy consumption.
\item[Level] District-level
\end{description}

\section{1 - Used PV}
\subsection*{Required Values}
\begin{tabularx}{0.85\textwidth}{Xll}
\multicolumn{3}{l}{\hspace{-6px}\textit{Given in CityLearn Framework:}}  \\
Total generated solar energy & $PV_{gen}$ & \\
& & \\
\multicolumn{3}{l}{\hspace{-6px}\textit{Calculated:}}  \\
Total consumed solar energy & $RE_{con}^{PV}$ & (Equation \ref{eq:re-con-pv})
\end{tabularx}

\subsection*{Formula}
\begin{equation}
 1 - \text{used~pv} = 1-\frac{1}{24}\sum_{t=1}^{24}\frac{RE_{con}^{PV,t}}{-PV_{gen}^t}.
\end{equation}
over all time steps~$t$.  

\begin{description}[leftmargin=3.15cm]
\item[Interpretation] The average daily fraction of consumed solar energy in the total produced solar energy.
\item[Level] Building- and District-level
\end{description}


\clearpage

\chapter{Algorithms of Social Methods}\label{sec:app-algos}
\begin{algorithm}
\caption{SAC-DemoPol}
\label{app:sac-social-1}
\small\textbf{Input:}   $\theta_1,\theta_2,\phi$ \Comment{\footnotesize Initial parameters}
\begin{algorithmic}[1]
\small \State $\bar{\theta}_1 \gets \theta_1, \bar{\theta}_2 \gets \theta_2$ \Comment{\footnotesize Initialize target network weights}
\small \State $\mathcal{D} \gets \emptyset$ \Comment{\footnotesize Initialize an empty replay buffer}
\small \For{each iteration}
	\small \For{each environment step}
		\small \State $\mathbf{a}_t \sim \pi_{\phi}(\mathbf{a}_t|\mathbf{s}_t)$ \Comment{\footnotesize Sample action from the policy}
		\small \State $\mathbf{s}_{t+1} \sim p(\mathbf{s}_{t+1}|\mathbf{s}_t,\mathbf{a}_t)$ \Comment{\footnotesize Sample next state from the environment}
		\small \State $\mathcal{D} \gets \mathcal{D} \cup \{(\mathbf{s}_t,\mathbf{a}_t,r(\mathbf{s}_t,\mathbf{a}_t),\mathbf{s}_{t+1})\}$ \Comment{\footnotesize Store the transition in the replay buffer}
	\small \EndFor
	\small \For{each gradient step}
		\small \State $\theta_i \gets \theta_i - \lambda_Q \hat{\triangledown}_{\theta_i}J_Q(\theta_i)$ for $i \in \{1,2\}$ \Comment{\footnotesize Update Q-function parameters}
		\small \State $\phi \gets \phi - \lambda _{\pi} \hat{\triangledown}_{\phi}J_{\pi}(\phi)$ \Comment{\footnotesize Update policy weights}
		\small \State $\alpha \gets \alpha - \lambda  \hat{\triangledown}_{\alpha}J(\alpha)$ \Comment{\footnotesize Adjust temperature}
		\small \State $\bar{\theta}_i \gets \tau\theta_i + (1-\tau)\bar{\theta}_i$ for $i \in \{1,2\}$ \Comment{\footnotesize Update target network weights}
		\small \For{each demonstrator $d$}
			\small \State $\mathbf{a}_t^d \sim \pi_{\phi}^d(\mathbf{a}_t^d|\mathbf{s}_t)$
			\small \State $\phi \gets \phi - \lambda _{\pi} \hat{\triangledown}_{\phi}J_{\pi}^{social}(\phi)$ \Comment{\footnotesize Social policy update}
		\small \EndFor
	\small \EndFor
\small \EndFor
\end{algorithmic}
\small \textbf{Output:}   $\theta_1,\theta_2,\phi$ \Comment{Optimized parameters}
\end{algorithm}

\begin{algorithm}
\caption{SAC-DemoQ}
\label{app:sac-social-2}
\small\textbf{Input:}   $\theta_1,\theta_2,\phi$ \Comment{\footnotesize Initial parameters}
\begin{algorithmic}[1]
\small \State $\bar{\theta}_1 \gets \theta_1, \bar{\theta}_2 \gets \theta_2$ \Comment{\footnotesize Initialize target network weights}
\small \State $\mathcal{D} \gets \emptyset$ \Comment{\footnotesize Initialize an empty replay buffer}
\small \For{each iteration}
	\small \For{each environment step}
		\small \State $\mathbf{a}_t \sim \pi_{\phi}(\mathbf{a}_t|\mathbf{s}_t)$ \Comment{\footnotesize Sample action from the policy}
		\small \State $\mathbf{s}_{t+1} \sim p(\mathbf{s}_{t+1}|\mathbf{s}_t,\mathbf{a}_t)$ \Comment{\footnotesize Sample next state from the environment}
		\small \State $\mathcal{D} \gets \mathcal{D} \cup \{(\mathbf{s}_t,\mathbf{a}_t,r(\mathbf{s}_t,\mathbf{a}_t),\mathbf{s}_{t+1})\}$ \Comment{\footnotesize Store the transition in the replay buffer}
	\small \EndFor
	\small \For{each gradient step}
		\small \State $\theta_i \gets \theta_i - \lambda_Q \hat{\triangledown}_{\theta_i}J_Q(\theta_i)$ for $i \in \{1,2\}$ \Comment{\footnotesize Update Q-function parameters}
		\small \State $\phi \gets \phi - \lambda _{\pi} \hat{\triangledown}_{\phi}J_{\pi}(\phi)$ \Comment{\footnotesize Update policy weights}
		\small \State $\alpha \gets \alpha - \lambda  \hat{\triangledown}_{\alpha}J(\alpha)$ \Comment{\footnotesize Adjust temperature}
		\small \State $\bar{\theta}_i \gets \tau\theta_i + (1-\tau)\bar{\theta}_i$ for $i \in \{1,2\}$ \Comment{\footnotesize Update target network weights}
		\small \For{each demonstrator $d$}
			\small \State $\theta_i \gets \theta_i - \lambda_Q \hat{\triangledown}_{\theta_i}J_Q^{social}(\theta_i)$ for $i \in \{1,2\}$ \Comment{\footnotesize Social Q-function update}
			\small \State $\bar{\theta}_i \gets \tau\theta_i + (1-\tau)\bar{\theta}_i$ for $i \in \{1,2\}$ \Comment{\footnotesize Update target network weights}
			\small \If{extra policy update}
				\small \State $\phi \gets \phi - \lambda _{\pi} \hat{\triangledown}_{\phi}J_{\pi}(\phi)$ \Comment{\footnotesize Update policy weights}
			\small \EndIf
		\small \EndFor
	\small \EndFor
\small \EndFor
\end{algorithmic}
\small \textbf{Output:}   $\theta_1,\theta_2,\phi$ \Comment{Optimized parameters}
\end{algorithm}

%\end{appendices)
