%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% LaTeX-Rahmen fuer das Erstellen von Masterarbeiten
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% allgemeine Einstellungen
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[twoside,12pt,a4paper]{report}
%\usepackage{reportpage}
\usepackage{epsf}
\usepackage{graphics, graphicx}
\usepackage{latexsym}
\usepackage[margin=10pt,font=small,labelfont=bf]{caption}
\usepackage[utf8]{inputenc}
\usepackage[toc,page]{appendix}


% Own packages
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{amssymb}
\usepackage{tabularx}
\usepackage{url}
\usepackage{amsmath}
\usepackage[permil]{overpic}

\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\textwidth 14cm
\textheight 22cm
\topmargin 0.0cm
\evensidemargin 1cm
\oddsidemargin 1cm
%\footskip 2cm
\parskip0.5explus0.1exminus0.1ex

% Kann von Student auch nach pers\"onlichem Geschmack ver\"andert werden.
\pagestyle{headings}

\sloppy

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% hier steht die neue Titelseite 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\begin{titlepage}
 \begin{center}
  {\LARGE Eberhard Karls Universit\"at T\"ubingen}\\
  {\large Mathematisch-Naturwissenschaftliche Fakult\"at \\
Wilhelm-Schickard-Institut f\"ur Informatik\\[4cm]}
  {\huge Master Thesis Computer Science\\[2cm]}
  {\Large\bf  Incorporating Social Learning into Multi-Agent Reinforcement Learning
to \\Lower Carbon Emissions in Energy Systems\\[1.5cm]}
 {\large Kristina Lietz}\\[0.5cm]
01.12.2023\\[4cm]
{\small\bf Reviewers}\\[0.5cm]
  \parbox{7cm}{\begin{center}{\large Dr. Nicole Ludwig}\\
   (Bioinformatik)\\
  {\footnotesize Wilhelm-Schickard-Institut f\"ur Informatik\\
	Universit\"at T\"ubingen}\end{center}}\hfill\parbox{7cm}{\begin{center}
  {\large Prof. Setareh Maghsudit}\\
  (Biologie/Medizin)\\
  {\footnotesize Medizinische Fakult\"at\\
	Universit\"at T\"ubingen}\end{center}
 }
  \end{center}
\end{titlepage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Titelr"uckseite: Bibliographische Angaben
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\thispagestyle{empty}
\vspace*{\fill}
\begin{minipage}{11.2cm}
\textbf{Lietz, Kristina:}\\
\emph{Incorporating Social Learning into Multi-Agent Reinforcement Learning
to Lower Carbon Emissions in Energy Systems}\\ Master Thesis Computer Science\\
Eberhard Karls Universit\"at T\"ubingen\\
Thesis period: 01.06.2023~-~01.12.2023
\end{minipage}
\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagenumbering{roman}
\setcounter{page}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Seite I: Zusammenfassug, Danksagung
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section*{Abstract}

\todo[inline]{Write here your abstract.}

\newpage
\section*{Zusammenfassung}

\todo[inline]{Bei einer englischen Masterarbeit muss zus\"atzlich eine deutsche Zusammenfassung verfasst werden.}

\newpage
\section*{Acknowledgements}

\todo[inline]{Write here your acknowledgements.}

\cleardoublepage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Table of Contents
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\baselinestretch}{1.3}
\small\normalsize

\tableofcontents

\renewcommand{\baselinestretch}{1}
\small\normalsize

\cleardoublepage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% List of Figures
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\baselinestretch}{1.3}
\small\normalsize

\addcontentsline{toc}{chapter}{List of Figures}
\listoffigures

\renewcommand{\baselinestretch}{1}
\small\normalsize

\cleardoublepage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% List of tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\baselinestretch}{1.3}
\small\normalsize

\addcontentsline{toc}{chapter}{List of Tables}
\listoftables

\renewcommand{\baselinestretch}{1}
\small\normalsize

\cleardoublepage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% List of abbreviations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% can be removed
\addcontentsline{toc}{chapter}{List of Abbreviations}
\chapter*{List of Abbreviations\markboth{LIST OF ABBREVIATIONS}{LIST OF ABBREVIATIONS}}
\todo[inline]{TODO}
\begin{tabbing}
\textbf{FACTOTUM}\hspace{1cm}\=Schrott\kill
\textbf{KL divergence}\>Kullback-Leibler divergence \\
\textbf{KPI}\>Key performance indicator \\
\textbf{kWh}\>Kilowatt hour \\
\textbf{MDP}\>Markov decision process \\
\textbf{NY}\> New York \\
\textbf{PV}\> Photovoltaic \\
\textbf{RL}\>Reinforcement learning \\
\textbf{SAC}\>Soft actor-critic \\
\textbf{SOC}\> State of the charge \\
\textbf{TD error}\> Temporal Difference error \\
\textbf{...} \> ...\\
\end{tabbing}

\cleardoublepage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Der Haupttext, ab hier mit arabischer Numerierung
%%% Mit \input{dateiname} werden die Datei `dateiname' eingebunden
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pagenumbering{arabic}
\setcounter{page}{1}

%% Introduction
\input{intro}
\begin{figure}[htb]
     \centerline{\epsffile{figures/chordal.eps}}
  \caption{Chordale Graphen}
  \label{fig2.1}
\end{figure}

Abbildung~\ref{fig2.1} zeigt ...

{
\renewcommand{\baselinestretch}{0.9} 
\normalsize
\begin{table}[htb]
\begin{tabular}{|p{2.7cm}||l|c|r|}
\hline
    \textbf{Spalte 1} 
  & \textbf{Spalte 2} 
  & \textbf{Spalte 3} 
  & \textbf{Spalte 4} \\
  \hline\hline
  xxx1111
  & xxxxxxx2222222
  & xxxxxx333333 
  & xxxxxxxxxx444444 \\
  \hline
    ...
  & ...
  & ...
  & ...\\
  \hline
\end{tabular}
  \caption[Beispieltabelle mit einer langen Legende]{Beispieltabelle mit einer langen Legende, damit man sieht, dass in der Legende der Zeilenabstand verringert wurde. Ausserdem soll auch der Font etwas kleiner gew\"ahlt werden. So sieht die ganze Umgebung kompakter aus.}
  \label{tabelle-1}
\end{table}
}
Referenzen: \cite{SaaSchTue97,TueConSaa96ismis,SchTueSaa98preprint}

\cleardoublepage

%% 
\input{Background}
\cleardoublepage

\chapter{Methods and Material}
  \label{sec:met-mat}

\noindent
\todo[inline]{Ziel dieses Kapitels ist eine Einf\"uhrung in die Thematik BlaBlaBla ...}

\section{CityLearn Framework}
\subsection{Presentation}
\label{sec:city-learn-presentation}
CityLearn \cite{vazquez2020citylearn} is a framework that utilizes RL applications to simulate and optimize building energy management. The framework requires the energy simulation of buildings as input data, which can include equipment electric power (i.e., non-shiftable load) and required energy for heating or cooling. For this work, only the non-shiftable load is taken into account. The buildings in the simulation are equipped with batteries that can be charged either with energy from the grid or their photovoltaic system. The amount of energy produced by the solar system at a point in time is also provided as an input time series. However, the buildings can only use their solar and battery energy themselves, so passing on surplus solar energy or discharging the battery to other buildings is not possible. The non-shiftable load must be covered by energy from the grid, produced solar energy, or discharging the battery at any time. An RL agent is trained for each building on charging or discharging its battery. By default, the framework operates hourly, expecting input data and actions to be performed hourly.

In addition, CityLearn offers the possibility to upload data sets on the weather (temperature, humidity, solar irradiance), weather forecasts (6h, 12h and 24h ahead), energy prices (and forecasts) and carbon emissions. These data sets can be combined with time-specific data (month, day type, hour) and building-specific data (load, solar generation, battery state of charge, energy consumption from the grid) to create a comprehensive state of the environment that is passed to the RL agents. However, the buildings can only observe their own building-specific data by default. Detailed information about the predefined state and action variables can be found on the CityLearn website\footnote{\url{https://www.citylearn.net}}.

The framework offers a range of key performance indicators (KPIs) based on the actions performed by the agents. These KPIs are available at both the building level and the district level (for all buildings combined). The framework is highly adaptable and can be customized to meet various objectives: Individual reward functions can be defined, custom data can be used, and custom algorithms can be used to train the agents.

\subsection{Adaptions}
\todo[inline]{Immer $\cdot$ oder immer $\times$}
Our goal was to minimize fossil energy use, which was not possible with the current state of the CityLearn framework. Therefore, we had to make some extensions regarding the state space of the environment and the KPIs, which are explained below.

First, we added the hourly fuel mix data from the grid as input. This dataset includes the renewable energy produced in kilowatt-hours (kWh) $E_{renewable}^t$ at time step $t$, as well as the percentage of renewable of the total energy produced. However, the former does not always correspond to the energy consumed by the buildings in the simulations. There would be too much or too little renewable energy available to compare the performance of the agents. Therefore, the median electricity consumption per hour $\bar{E}_b$ in kWh is expected as input for each building. Then, the absolute renewable energy generated by the grid is calculated as 
\begin{equation}
	\hat{E}_{renewable}^t = E_{renewable}^t \cdot k\sum_{b\in B} \bar{E}_b,
\end{equation}
and thus scaled to a value corresponding to the median energy consumption of the buildings. Here, $k$ is an optional scaling factor. If more energy is consumed from the grid than the renewable energy generated, we assume that this excess energy comes from fossil sources.

Since a significant part of the renewable energy produced is wind energy, we further added the current wind speed in $m/s$ as well as the forecasts with a forecast horizon of 6h, 12h and 24h corresponding to the other forecasts in the framework to the state of the environment.

\section{Datasets}
\todo[inline]{(all units in kWh) ????!!!! Also in the following!!!!!!!!!!}
\subsection{Building data}
\label{sec:building-data}
We utilized the data provided by CityLearn for the 2021 CityLearn Challenge \cite{citylearn-challenge} to build our building datasets. These datasets consist of the specifications for the battery and PV of 13 buildings, along with the non-shiftable load time series for one year. Each building has a battery with attributes specified in Appendix \ref{app:battery-attributes}. Also, Building 4 and Buildings 10-17 have a 5 kW nominal power PV, while all other buildings have a PV with a nominal power of 4 kW.

We conducted a new simulation for the time series of solar power generation for the buildings, as we used different weather data than in the challenge. To carry out the simulation, we used the Python library pvlib \cite{holmgren2018pvlib} and followed the instructions provided on their website\footnote{see \url{https://pvlib-python.readthedocs.io/en/latest/gallery/adr-pvarray/plot_simulate_fast.html}}. The weather data we used is described in Section \ref{sec:weather-data}, and for the location, we used 42°17.98'N, -74°22.2'E. Furthermore, we set the default test condition power output of the PV for each building to be the maximum solar generation of the original data and added 500 W to attain a nearly equivalent median generation of all buildings as in the original dataset.

To obtain the median values for energy consumption per hour, we trained the SAC agent with the default hyperparameters from CityLearn for three episodes using the default reward function and the weather data described in Section \ref{sec:weather-data}. The medians obtained are listed in the Appendix \ref{tab:building-medians}.

\subsection{Fuelmix and Weather data}
\label{sec:weather-data}
The fuel mix data we used is obtained from the \textcolor{red}{NY-ISO}, retrieved on the 7th of June 2023 \cite{fuelmix_nyiso}. The original data provides the produced energy in MW for each of the energy sources dual fuel, natural gas, nuclear, \textcolor{red}{other fossil fuels}, wind, hydro, and \textcolor{red}{other renewables} for a time interval of 5 minutes for 2021 in the New York (NY) state. Since we are only interested in renewable (wind, hydro, other renewables) or non-renewable (all others) energy produced, we summed these values up and calculated the value in kWh. \todo[inline]{kW vs MW vs kWh????} To meed the hourly time steps of the building data, we calculated the hourly mean of the values, because \textcolor{red}{???}. The final fuelmix data contains the hourly amount of energy produced with renewable sources in kWh and the share of renewable energy produced calculated as the absolute amount of renewable energy produced devided by the total produced energy. The renewable share is calculated on the original time steps of five minutes, so for the final dataset here also the median per hour was calculated. Note, that this data does not include the solar generation of the buildings described in Chapter \ref{sec:building-data}, but only the renewable energy from the grid. 

As weather data, we used data from the New York state too, in order to encourage correlation between the weather and the produced amount of renewable energy. We obtained the data from the \textcolor{red}{NSRDB} \cite{weather_nsrdb}. 
\todo[inline]{forecasts}

\todo[inline]{fuel mix scaled to 0.5 (somtetimes buildings use full available from grid -> capture this behaviour)}

%% 
\input{MM}
\cleardoublepage

%%
\input{results}
Used PV of available\\
$possible\_battery\_input_{b,t} = \min(\min(C^b_t-SOC^b_t, 0), max\_input\_power_{b, \textcolor{red}{t=last}})$\\
\\
$could\_used\_without\_pv_{b,t} = possible\_battery\_input_{b,t} + net\_electricity\_consumption\_without\_storage\_and\_pv_{b,t} $ \\
\\
$could\_used\_with\_pv_{b,t} = \max(possible\_battery\_input_{b,t} + net\_electricity\_consumption\_without\_storage\_and\_pv_{b,t} - solar\_generation_{b,t}*-1, 0)$ \\
\\
$pv\_could\_have\_used_{b,t} = \min(solar\_generation_{b,t}*-1, could\_used\_without\_pv_{b,t})$ \\
\\
$pv\_used_{b,t} = E_{used_{pv_{b,t}}} = \max(\min(e_{net}^b - e_{pv}^b, - e_{pv}^b), 0) $ \\
\\
$pv\_used\_of\_available_{b,t} = used_{b,t}/pv\_could\_have\_used_{b,t}$\\
\\
$grid\_could\_have\_used_{t} = \min(E_{r,grid_{t}}, \sum_{b\in Buildings}could\_used\_with\_pv_{b,t})$ \\
\\
$grid\_used_{t} = E_{used_{r,grid_{t}}} = \min(E_{net_{pos}}, E_{r, grid})$ \\
\\
$grid\_used\_of\_available_{t} = grid\_used_{b,t} / grid\_could\_have\_used_{b,t}$ \\
\\
$total\_could\_have\_used_{t} = \min(E_{r,grid_{t}} + \sum_{b\in Buildings} \min(solar\_generation_{b,t}*-1, could\_used\_without\_pv_{b,t}), \sum_{b\in Buildings}could\_used\_with\_pv_{b,t}))$ \\
\\
$total\_used_{t} = E_{used_{r}} = E_{used_{r,grid}}  + E_{used_{pv}}$ \\
\\
$total\_used\_of\_available_{t} = total\_used_{t} / total\_could\_have\_used_{t}$


\cleardoublepage

%%
\input{discussion}
\cleardoublepage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Appendix
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix

%\setcounter{secnumdepth}{-1}
%\section{Tables}\label{chap:App}
\chapter{Appendix}\label{chap:App}
\begin{table}[htb]
\begin{tabularx}{\linewidth}{lXc}
Attribute name & Description & Value \\ \hline
Capacity & Maximum amount of energy the storage device can store & 6.4 kWh \\
Efficiency & Technical efficiency & 90 \% \\
Capacity loss coefficient & Storage capacity lost in each charge and discharge cycle (as a fraction of the total capacity) & $1e^{-5}$ \\
Loss coefficient & Standby hourly losses & 0 \\
Nominal power & Maximum amount of electric power that the battery can use to charge or discharge & 5 \textcolor{red}{kW}
\end{tabularx}
\caption[Attributes of the batteries of each building]{Attributes of the batteries of each building. Description of the attributes obtained from \textcolor{red}{TODO source}}
\label{app:battery-attributes}
\end{table}

%\chapter{Figures}\label{chap:App2}

\begin{table}[htb]
\center
\begin{tabular}{c|c}
Building Id & Energy Consumption Median 
%& Energy Consumption without storage Median & Energy Consumption without storage and PV Median 
\\  \hline
1  & 0.54 %& 0.58 & 0.81 
\\
2  & 0.45 %& 0.49 & 0.74 
\\
3  & 0.25 %& 0.28 & 0.56 
\\
4 & 0.52 %& 0.54 & 0.94  
\\
5 & 0.29 %& 0.29 & 0.74 
\\
6 & 0.5 % & 0.56 & 1.08 
\\
7 & 0.21 %& 0.21 & 0.33 
\\
8 & 0.31 %& 0.32 & 0.68 
\\
9  & 0.36 %& 0.38 & 0.46 
\\
10 & 0.56 %& 0.65 & 0.98
\\
11 & 0.66 %& 0.71 & 1.19 
\\
12 & 0.0 %& 0.0 & 0.0 
\\
13 & 0.43 %& 0.48 & 0.97 
\\
14 & 0.49 %& 0.48 & 0.59 
\\
15 & 0.12 %& 0.0 & 0.0 
\\
16 & 0.55 %& 0.72 & 1.2 
\\
17 & 0.75% & 0.82 & 1.24 \\
\end{tabular}
\caption{\textcolor{red}{Zweite Appendix-Tabelle}}
\label{tab:building-medians}
\end{table}
%\end{appendices)

\cleardoublepage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Bibliographie
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\addcontentsline{toc}{chapter}{Bibliography}

\bibliographystyle{alpha}
\bibliography{thesislit}
%% Obige Anweisung legt fest, dass BibTeX-Datei `mylit.bib' verwendet
%% wird. Hier koennen mehrere Dateinamen mit Kommata getrennt aufgelistet
%% werden.

\cleardoublepage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Erklaerung
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\thispagestyle{empty}
\section*{Selbst\"andigkeitserkl\"arung}

Hiermit versichere ich, dass ich die vorliegende Masterarbeit 
selbst\"andig und nur mit den angegebenen Hilfsmitteln angefertigt habe und dass alle Stellen, die dem Wortlaut oder dem 
Sinne nach anderen Werken entnommen sind, durch Angaben von Quellen als 
Entlehnung kenntlich gemacht worden sind. 
Diese Masterarbeit wurde in gleicher oder \"ahnlicher Form in keinem anderen 
Studiengang als Pr\"ufungsleistung vorgelegt. 

\vskip 3cm

Ort, Datum	\hfill Unterschrift \hfill 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Ende
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{document}

